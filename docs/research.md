# 调研报告


## 小组成员
-   柯景瀚
-   吴骏  
-   丁程
-   余丰
-   王腾岳
-   wkdwy(蜗壳动物园)荣誉出品


## 目录
-  [调研报告](#调研报告)
		-  [小组成员](#小组成员)
		- [目录](#目录)
		- [项目概述](#项目概述)
		- [项目背景](#项目背景)
			- [日志文件系统](### 日志型文件系统)
			- [APFS](### 日志型文件系统)
			- [Juicefs](### 日志型文件系统)
			- [数据一致性问题](### 日志型文件系统)
			  - [CRDT](#### CRDT理论)
			  - [Paxos](#### Paxos算法)
			- [分布式文件系统的高性能问题](### 分布式文件系统中的高性能问题)
				- [使用缓存](#### 使用缓存)
		- [立项依据](## 立项依据)
		- [前瞻性/重要性分析](## 前瞻性/重要性分析)
		- [相关工作](## 相关工作)
		- [参考文献](## 参考文献)

## 项目概述


## 项目背景

### 日志型文件系统

**日志文件系统**（英语：Journaling file system）是一种文件系统。在发生变化时，它先把相关的信息写入一个被称为**日志**的区域，然后再把变化写入主文件系统。在文件系统发生故障（如内核崩溃或突然停电）时，日志文件系统更容易保持一致性，并且可以较快恢复。

对文件系统进行修改时，需要进行很多操作。这些操作可能中途被打断，也就是说，这些操作不是“不可中断”(atomic)的。如果操作被打断，就可能造成文件系统出现不一致的状态。

例如：删除文件时，先要从目录树中移除文件的标示，然后收回文件占用的空间。如果在这两步之间操作被打断，文件占用的空间就无法收回。文件系统认为它是被占用的，但实际上目录树中已经找不到使用它的文件了。

在非日志文件系统中，要检查并修复类似的错误就必须对整个文件系统的数据结构进行检查。一般在挂载文件系统前，操作系统会检查它上次是否被成功卸载，如果没有，就会对其进行检查。如果文件系统很大或者**I/O**有限，这个操作可能会花费很长时间。

为了避免这样的问题，日志文件系统分配了一个称为日志（journal）的区域来提前记录要对文件系统做的更改。在崩溃后，只要读取日志重新执行未完成的操作，文件系统就可以恢复一致。这种恢复是原子的，因为只存在几种情况：

-   不需要重新执行：这个事务被标记为已经完成
-   成功重新执行：根据日志，这个事务被重新执行
-   无法重新执行：这个事务会被撤销，就如同这个事务从来没有发生过
-   日志本身不完整：事务还没有被完全写入日志，它会被简单忽略

### APFS(Apple File System) 

apfs是apple公司推出的取代HFS+的文件系统，它的性能优秀，并且采用了一种日志的机制来增改文件，作为重要的Crash protection的手段，它为了避免由系统崩溃而引起的元数据的损坏，它并不是在覆盖现有元数据的情况下进行数据的删改，而是编写日志记录，然后将指针指向新记录，释放旧记录，这样就避免了由于更新过程中发生的崩溃而导致的包含部分旧数据和部分新数据的损坏记录。它的这种方法同时还避免了不得不两次写入变化，就像HFS+一样，变化首先被写入日志，然后再被写入目录文件。

### Juicefs

JuiceFS 是一款面向云环境设计的高性能共享文件系统，在 AGPL v3.0 开源协议下发布。提供完备的 POSIX 兼容性，可将海量低价的云存储作为本地磁盘使用，亦可同时被多台主机同时挂载读写。使用 JuiceFS 存储数据，数据本身会被持久化在对象存储（例如，Amazon S3），而数据所对应的元数据可以根据场景需要被持久化在 Redis、MySQL、SQLite 等多种数据库中。但是对于这个文件系统来说，尽管JuiceFS拥有很多的优点，而且很努力的去逼近本地存储的性能，但网络延迟，IOPS以及对象存储自身的限制，在写方面，依然和本地存储(SSD)有接近百倍的性能差距，这对于很多OLTP数据库是有比较大的影响的，但对读的优化，使得其对于OLAP等以读多的引擎则帮助巨大。详细信息见[juicsfs](https://github.com/juicedata/juicefs)。


### 数据一致性问题

#### CRDT理论
​	CRDT，全称无冲突复制数据类型(Conflict-free Replicated Data Type)，在具体阐述之前，先简要介绍一下分布式系统的CAP理论。

CRDT理论主要包括以下几个方面：

​	强一致性(Consistency)： 即在分布式系统中的同一数据多副本情形下， 对千数据的更新操作体现出的效果与只有单份数据是一样的。

​	可用性(Availability)： 客户端在任何时刻对大规模数据系统的读／写操作都应该保证在限定延时内完成。

​	分区容忍性(Partition Tolerance)： 在大规模分布式数据系统中， 网络分区现象， 即分区间的机器无法进行网络通信的情况是必然会发生的， 所以系统应该能够在这种情况下仍然继续工作。

​	CAP 最初是由Eric Brewer于1999 年首先提出的， 他同时证明了：**对于一个大规模分布式数据系统来说， CAP 三要素不可兼得**， 同一个系统至多只能实现其中的两个， 而必须放宽第3 个要素来保证其他两个要素被满足。
关于CRDT的详细介绍见![[CRDT调研报告]]
#### Paxos算法
​	Paxos算法是Lamport提出的一种基于消息传递的分布式一致性算法，使其获得2013年图灵奖。Paxos由Lamport于1998年在《The Part-Time Parliament》论文中首次公开，最初的描述使用希腊的一个小岛Paxos作为比喻，描述了Paxos小岛中通过决议的流程，并以此命名这个算法，但是这个描述理解起来比较有挑战性。后来在2001年，Lamport觉得同行不能理解他的幽默感，于是重新发表了朴实的算法描述版本《Paxos Made Simple》。自Paxos问世以来就持续垄断了分布式一致性算法，Paxos这个名词几乎等同于分布式一致性。Google的很多大型分布式系统都采用了Paxos算法来解决分布式一致性问题，如Chubby、Megastore以及Spanner等。开源的ZooKeeper，以及MySQL 5.7推出的用来取代传统的主从复制的MySQL Group Replication等纷纷采用Paxos算法解决分布式一致性问题。
​	算法具体描述参见Lamport的论文《Paxos Made Simple》。其中一个比较完善的实现是腾讯的一个工程：[phxpaxos](https://github.com/Tencent/phxpaxos)
PhxPaxos是腾讯公司微信后台团队自主研发的一套基于Paxos协议的多机状态拷贝类库。它以库函数的方式嵌入到开发者的代码当中， 使得一些单机状态服务可以扩展到多机器，从而获得强一致性的多副本以及自动容灾的特性。 这个类库在微信服务里面经过一系列的工程验证，并且腾讯方面对它进行过大量的恶劣环境下的测试，使其在一致性的保证上更为健壮。
关于该部分的详细介绍见仓库内报告：[[分布式文件系统的数据一致性]]。

### 分布式文件系统中的高性能问题

对一个分布式文件系统而言，性能是非常关键的衡量标准，有一些特性是一个分布式文件系统必须要满足的，否则就无法有竞争力。主要如下：

-   应该符合 POSIX 的文件接口标准，使该系统易于使用，同时对于用户的遗留系统也无需改造；
-   对用户透明，能够像使用本地文件系统那样直接使用；
-   持久化，保证数据不会丢失；
-   具有伸缩性，当数据压力逐渐增长时能顺利扩容；
-   具有可靠的安全机制，保证数据安全；
-   数据一致性，只要文件内容不发生变化，什么时候去读，得到的内容应该都是一样的。

除此之外，还有些特性是分布式加分项，具体如下：

-   支持的空间越大越好；
-   支持的并发访问请求越多越好；
-   性能越快越好；
-   硬件资源的利用率越高越合理越好。
#### 使用缓存
文件系统中可以使用缓存来实现性能的提升，对于一个由对象存储和数据库组合驱动的文件系统，缓存是本地客户端与远端服务之间高效交互的重要纽带。读写的数据可以提前或者异步载入缓存，再由客户端在后台与远端服务交互执行异步上传或预取数据。相比直接与远端服务交互，采用缓存技术可以大大降低存储操作的延时并提高数据吞吐量。
在这里Juicsfs实现了比较高效的缓存机制。详细内容见[juicsfs cache_management](https://juicefs.com/docs/zh/community/cache_management)。








## 立项依据

如上所言，分布式文件系统在现在有着越来越多的应用范围，它的性能逐渐成为一个非常重要的指标，对于现有的分布式文件系统来说，如juicsfs等，其读写性能仍然未能达到我们所期望的高性能文件系统所应该有的标准。在这里我们决定从三个不同的方向优化打造一个高性能的文件系统——缓存，地址的哈希映射和日志文件系统三个方面来优化2021年的OSH项目[x-DisGraFS](https://github.com/OSH-2021/x-DisGraFS)。利用它实现的一个对文件内容的打标搜索，提高原有文件系统的性能，打造一个高性能的分布式文件系统。

## 前瞻性/重要性分析


## 相关工作


## 参考文献
[日志文件系统wiki](https://zh.wikipedia.org/zh-cn/%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F)